# Make RCS.

# Copyright (C) 2010 Thien-Thi Nguyen
# Copyright (C) 1990, 1991, 1992, 1993, 1994, 1995 Paul Eggert
# Copyright (C) 1982, 1988, 1989 Walter Tichy
#
# This file is part of GNU RCS.
#
# GNU RCS is free software: you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.
#
# GNU RCS is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty
# of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
# See the GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# default target
default :: all

# See the top-level README for more information on the configuration section.
# ----- start of configuration section -----

srcdir = @srcdir@
bauxdir = $(srcdir)/../build-aux
VPATH = @srcdir@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@

CC = @CC@
CPPFLAGS = @CPPFLAGS@
CFLAGS = @CFLAGS@
DEFS = @DEFS@
INSTALL = @INSTALL@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
LDFLAGS = @LDFLAGS@
LIBS = @LIBS@
x = @EXEEXT@
o = .@OBJEXT@
LIBOBJS = @LIBOBJS@

# This is for the benefit of "make installcheck".
# Note that it should end in ":".
PATHPREFIX =

TESTS_ENVIRONMENT = PATH="$(PATHPREFIX)$$(pwd)/0pre/bin:$$PATH" sh
TESTS = alive.test

# The following definitions can be tailored by hand;
# this shouldn't be needed for ordinary installations.

 ALL_CFLAGS = $(CPPFLAGS) $(DEFS) -I. -I$(srcdir) $(CFLAGS)

 LINK = $(CC)

 LINT = lint -abchx# traditional and BSD lint
#LINT = lint# System V lint

 REMOVE = rm -f

# ----- end of configuration section -----
# You shouldn't have to change anything past this point.


# Avoid brain damage in some versions of 'make'.
SHELL = /bin/sh

PROGRAMS = ci$x co$x ident$x merge$x \
	rcs$x rcsclean$x rcsdiff$x rcsmerge$x rlog$x

all :: $(PROGRAMS)

.SUFFIXES :
.SUFFIXES : .c $o
.c$o :
	$(CC) -o $@ -c $(ALL_CFLAGS) $<

installdirs :: $(bauxdir)/mkinstalldirs
	$(bauxdir)/mkinstalldirs $(bindir)

install :: all installdirs
	for p in $(PROGRAMS); do \
	  $(INSTALL_PROGRAM) $$p $(bindir)/$$p; \
	done

uninstall ::
	for p in $(PROGRAMS); do \
	  $(REMOVE) $(bindir)/$$p; \
	done

check: test-prep
	@ls='$(TESTS)' ; if [ "$$ls" ] ; then	\
	  if [ '.' = '$(srcdir)' ] ; then d= ;	\
	    else d='$(srcdir)/' ; fi ;		\
	  for t in "$$ls" ; do			\
	    if $(TESTS_ENVIRONMENT) "$$d$$t" ;	\
	    then echo "PASS: $$t" ;		\
	    else echo "FAIL: $$t" ;		\
	    fi ;				\
	  done ;				\
	fi

# Install RCS and (if applicable) GNU diff before running these tests.
installcheck :: test-prep
	$(MAKE) check PATHPREFIX='$(bindir):'

test-clean:
	rm -rf 0pre RCS
	rm -f a.* xorlf*

clean :: test-clean
	$(REMOVE) librcsparts.a
	$(REMOVE) *$o *-help.c
	$(REMOVE) $(PROGRAMS)
	$(REMOVE) core core.* *.core

mostlyclean :: clean

distclean :: mostlyclean
	$(REMOVE) bother.c Makefile

maintainer-clean :: distclean
	@echo "This command is intended for maintainers to use;"
	@echo "it deletes files that may require special tools to rebuild."
	$(REMOVE) TAGS

bother.c: FORCE
	@( echo '/* brooked other (shared mother) */' ; \
	   echo 'const char const prog_co[] = "$(bindir)/co";' ; \
	   echo 'const char const prog_merge[] = "$(bindir)/merge";' ; \
	   ) > $@T
	@if [ -f $@ ] && cmp -s $@T $@ ; \
	  then rm -f $@T ; \
	  else mv $@T $@ ; echo Created $@ ; \
	fi

%$x : %$o librcsparts.a
	$(LINK) -o $@ $< -L. -lrcsparts $(LIBS)

%-help.c : %.c
	$(bauxdir)/extract-help -o $@ $<

SOURCE=	gnu-h-v.c \
	ci.c co.c ident.c maketime.c merge.c merger.c partime.c rcs.c \
	rcsclean.c rcsdiff.c rcsedit.c rcsfcmp.c rcsfnms.c rcsgen.c \
	rcskeep.c rcskeys.c rcslex.c rcsmap.c rcsmerge.c rcsrev.c rcssyn.c \
	rcstime.c rcsutil.c rlog.c
PROGS=	ci$o co$o ident$o merge$o rcs$o rcsclean$o rcsdiff$o rcsmerge$o rlog$o
PARTS=	gnu-h-v$o bother$o \
	maketime$o merger$o partime$o rcsedit$o rcsfcmp$o rcsfnms$o \
	rcsgen$o rcskeep$o rcskeys$o rcslex$o rcsmap$o rcsrev$o rcssyn$o \
	rcstime$o rcsutil$o
OBJECT=	$(PROGS) $(PARTS)

librcsparts.a: librcsparts.a($(PARTS))
	ranlib $@

TAGS : $(SOURCE)
	etags $(SOURCE)

dvi info ::

$(OBJECT) : rcsbase.h
maketime$o partime$o rcstime$o : partime.h
maketime$o rcstime$o : maketime.h

# gross
ci$o : ci-help.c
co$o : co-help.c
ident$o : ident-help.c
merge$o : merge-help.c
rcs$o : rcs-help.c
rcsclean$o : rcsclean-help.c
rcsdiff$o : rcsdiff-help.c
rcsmerge$o : rcsmerge-help.c
rlog$o : rlog-help.c

FORCE:

test-prep: all
	@if [ -d 0pre ] &&					\
	    [ 0pre = $$(ls -1td 0pre $(PROGRAMS) | sed 1q) ] ;	\
        then : ; else						\
	  rm -rf 0pre ; mkdir 0pre 0pre/bin 0pre/stash ;	\
	  cp -p $(PROGRAMS) *$o *.a bother.c 0pre/stash ;	\
	  $(MAKE) all bindir=$$(pwd)/0pre/bin >/dev/null ;	\
	  $(MAKE) xorlf >/dev/null ;				\
	  mv -v $(PROGRAMS) xorlf 0pre/bin ;			\
	  cp -pf 0pre/stash/* . ;				\
	fi

xorlf:
	@{ echo '#include <stdio.h>'               ;	\
	   echo 'int main ()'                      ;	\
	   echo '{'                                ;	\
	   echo '  int c;'                         ;	\
	   echo '  while (EOF != (c = getchar()))' ;	\
	   echo '    putchar (c ^ 012);'           ;	\
	   echo '  return 0;'                      ;	\
	   echo '}'                                ;	\
	} > $@.c
	$(CC) -o $@ $@.c
	$(REMOVE) $@.c
