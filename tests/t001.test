# t001.test                                             -*- shell-script -*-

. common

w=$wd/x
v=$wd/x,v

# Initialize empty RCS file.
do_and_show 'rcs -i -t-t001 $v' ; do_rlog ; cp $v ${v}SAVE
# Add a revision.
echo nonempty > $w
do_and_show 'ci -u -r4.20 -mHELLO $w'

# Name it (via rcs, not via ci).
do_and_show 'rcs -nWONDERFUL: $w' ; do_rlog | tee $wd/last-rlog

# We expect the name to appear in the RCS file.
grep '	WONDERFUL: 4.20' $wd/last-rlog \
    || exit 1

# Remove the name.
do_and_show 'rcs -nWONDERFUL $w' ; do_rlog | tee $wd/last-rlog

# We expect the name to NOT appear in the RCS file.
grep '	WONDERFUL: 4.20' $wd/last-rlog \
    && exit 1

# Check that both ‘BRNUM’ and ‘BRNUM.’ resolve to the branch tip.
co -p4  $v >$wd/DOT-0 || exit 1
co -p4. $v >$wd/DOT-1 || exit 1
test '' = $(diff $wd/DOT-0 $wd/DOT-1) \
    && exit 1

# This function is for the subsequent access-list tests.
getaccesslist ()
{
    echo $(rlog $w | sed -e '/^access/,/^symbolic/!d;/^[as]/d')
}

# Add some logins to the access list.
do_and_show 'rcs -afoo,bar -abaz $w'

# We expect the logins to appear in the RCS file.
test 'foo bar baz' = "$(getaccesslist)" \
    || exit 1

# Try to add some previously added logins.
do_and_show 'rcs -abaz,bar $w'

# We expect there to be no change.
test 'foo bar baz' = "$(getaccesslist)" \
    || exit 1

# Zonk one.
do_and_show 'rcs -efoo $w'

# We expect it to NOT appear in the RCS file.
test 'bar baz' = "$(getaccesslist)" \
    || exit 1

##
# The regression introduced 2010-04-27, "Add abstraction: fro_spew_partial",
# manifests as the omission of all output produced via ‘fro_spew_partial’.
# This includes ‘atat_display’ output used, e.g., to display the log.
##

# Arrange for the RCS file size to surpass the ‘RM_STDIO’ threshold.
# (At time of writing this is hardcoded to 256 kilobytes.)
echo 'to be (bloated) or not to be be (bloated), that is the question' > $wd/B00
for i in 00 01 02 03 04 05 06 07 08 09 10 11 ; do
    cat $wd/B$i $wd/B$i > $wd/B$(printf "%02d" $(expr 1 + $i))
done
co -l $w
cat $wd/B12 >> $w
ci -u -mbloat $w
do_rlog | tee $wd/last-rlog

# We expect rlog(1) to work.
grep '|bloat' $wd/last-rlog \
    || exit 1

exit 0

# t001.test ends here
